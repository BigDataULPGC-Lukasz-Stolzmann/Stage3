# Distributed Search Engine Gateway & Load Balancer
#
# This configuration acts as the single entry point for all external traffic (Clients, UI).
# It abstracts the underlying cluster topology, allowing nodes to scale horizontally
# without requiring client reconfiguration.
#
# ## Responsibilities
# 1. Load Balancing: Distributes incoming requests across available worker nodes.
# 2. Protocol Termination: Handles HTTP/80 traffic and forwards to internal application ports.
# 3. Timeout Management: Enforces specific time limits based on the nature of the request (e.g., long ingestion vs. fast search).

events {
    # Standard event model configuration for handling concurrent connections.
    worker_connections 1024;
}

http {
    # --- Cluster Topology Definition ---
    # Defines the pool of upstream application nodes.
    # New nodes must be added here to participate in receiving external traffic.
    #
    # Format: IP:PORT
    # Note: The application server (Axum) typically runs on `gossip_port + 1000`.
    upstream search_cluster {
        # Load Balancing Algorithm: Least Connections
        # Routes traffic to the node with the fewest active connections.
        # This is ideal for heterogenous workloads (mixed search/ingest) where
        # requests can have varying processing times.
        least_conn;

        # Node Pool Configuration
        # 'max_fails=3 fail_timeout=10s': Passive health check.
        # If a node fails 3 times in 10s, it is temporarily removed from rotation.
        server 192.168.1.170:6000 max_fails=3 fail_timeout=10s;
        server 192.168.1.133:6000 max_fails=3 fail_timeout=10s;
    }

    server {
        # Expose the gateway on standard HTTP port 80.
        listen 80;

        # --- Endpoint: System Health ---
        # Used by monitoring tools or the UI to verify cluster reachability.
        location /health {
            proxy_pass http://search_cluster;
            
            # Fast timeouts for health checks to fail quickly if the cluster is down.
            proxy_connect_timeout 2s;
            proxy_read_timeout 5s;
        }

        # --- Endpoint: Search Queries ---
        # Handles user search requests.
        # Requires a moderate timeout to allow for distributed scatter-gather logic
        # across the partition map.
        location /search {
            proxy_pass http://search_cluster;
            proxy_connect_timeout 5s;
            proxy_read_timeout 30s;
        }

        # --- Endpoint: Document Ingestion ---
        # Handles heavy write operations (downloading Project Gutenberg books).
        #
        # Critical Configuration:
        # `proxy_read_timeout 120s`: Ingestion involves external network calls and
        # text processing. We significantly extend the timeout here to prevent
        # Nginx from severing the connection while the node is still processing the book.
        location /ingest {
            proxy_pass http://search_cluster;
            proxy_connect_timeout 5s;
            proxy_read_timeout 120s;
        }

        # --- Endpoint: Metadata Operations ---
        # Access to the 'books' distributed map (e.g., retrieving titles/authors).
        location /books {
            proxy_pass http://search_cluster;
            proxy_connect_timeout 5s;
            proxy_read_timeout 30s;
        }

        # --- Catch-All Fallback ---
        # Proxies any other API requests (like /api/stats) to the cluster.
        location / {
            proxy_pass http://search_cluster;
            proxy_connect_timeout 5s;
            proxy_read_timeout 30s;

            # Header Propagation
            # Ensures the backend nodes see the original client IP, not the Nginx container IP.
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}