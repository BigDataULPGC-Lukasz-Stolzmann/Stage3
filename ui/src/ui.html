<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Search UI</title>
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --border: #e2e4ea;
      --text: #1f2430;
      --muted: #606778;
      --accent: #2b7bff;
      --accent-soft: #e7f0ff;
      --danger: #d64545;
      --ok: #2f8f5b;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "IBM Plex Sans", "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 28px 18px 60px;
    }

    .wrap {
      max-width: 1024px;
      margin: 0 auto;
      display: grid;
      gap: 20px;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    h1 {
      margin: 0;
      font-size: clamp(22px, 3vw, 32px);
    }

    .subtitle {
      color: var(--muted);
      font-size: 14px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    label {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    input {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 15px;
      width: 100%;
    }

    button {
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 14px;
      font-weight: 600;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
    }

    button.secondary {
      background: var(--accent-soft);
      color: var(--accent);
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .status {
      font-size: 13px;
      color: var(--muted);
      min-height: 18px;
    }

    .status.ok { color: var(--ok); }
    .status.error { color: var(--danger); }

    pre {
      background: #f2f4f8;
      border-radius: 8px;
      padding: 10px;
      font-size: 12px;
      margin: 0;
      overflow-x: auto;
    }

    .stats-grid {
      display: grid;
      gap: 8px;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    .stat {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      background: #fafbff;
    }

    .stat h3 {
      margin: 0;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
    }

    .stat p {
      margin: 6px 0 0;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Distributed Search UI</h1>
      <div class="subtitle">Enter the node URL you want to query and manage.</div>
    </header>

    <section class="card">
      <label>Node URL</label>
      <div class="row">
        <input id="nodeUrl" type="text" placeholder="http://192.168.1.133:6000" />
        <button class="secondary" onclick="saveNode()">Use Node</button>
      </div>
      <div class="status" id="nodeStatus"></div>
    </section>

    <div class="grid">
      <section class="card">
        <label>Ingest Book</label>
        <div class="row">
          <input id="bookId" type="number" min="1" placeholder="Gutenberg book id" />
          <button onclick="ingest()">Ingest</button>
          <button class="secondary" onclick="checkStatus()">Check Status</button>
        </div>
        <div id="ingestStatus" class="status"></div>
        <pre id="ingestOutput"></pre>
      </section>

      <section class="card">
        <label>Search</label>
        <div class="row">
          <input id="query" type="text" placeholder="Query term" />
          <input id="limit" type="number" min="1" max="50" value="5" />
          <button onclick="search()">Search</button>
        </div>
        <div id="searchStatus" class="status"></div>
        <pre id="searchOutput"></pre>
      </section>
    </div>

    <section class="card">
      <label>Node Stats</label>
      <div class="stats-grid" id="statsGrid"></div>
      <div class="status" id="statsStatus"></div>
    </section>

    <section class="card">
      <label>Test Queries</label>
      <div class="subtitle">Try: elizabeth, darcy, pride, adventure, voyage</div>
    </section>
  </div>

  <script>
    const ingestStatus = document.getElementById("ingestStatus");
    const ingestOutput = document.getElementById("ingestOutput");
    const searchStatus = document.getElementById("searchStatus");
    const searchOutput = document.getElementById("searchOutput");
    const statsGrid = document.getElementById("statsGrid");
    const statsStatus = document.getElementById("statsStatus");
    const nodeStatus = document.getElementById("nodeStatus");
    const nodeInput = document.getElementById("nodeUrl");

    const defaultNode = localStorage.getItem("nodeUrl") || "http://127.0.0.1:6000";
    nodeInput.value = defaultNode;

    function currentNode() {
      return nodeInput.value.trim();
    }

    function saveNode() {
      const node = currentNode();
      if (!node) return setStatus(nodeStatus, "Enter node URL", true);
      localStorage.setItem("nodeUrl", node);
      setStatus(nodeStatus, "Node saved.");
      pollStats();
    }

    async function ingest() {
      const id = document.getElementById("bookId").value.trim();
      if (!id) return setStatus(ingestStatus, "Provide an id", true);
      setStatus(ingestStatus, "Ingesting...");
      ingestOutput.textContent = "";
      try {
        const res = await fetch(`/api/ingest?id=${encodeURIComponent(id)}&node=${encodeURIComponent(currentNode())}`, { method: "POST" });
        const data = await res.json();
        setStatus(ingestStatus, res.ok ? "Ingested." : "Ingest failed.", !res.ok);
        ingestOutput.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        setStatus(ingestStatus, "Request failed", true);
      }
    }

    async function checkStatus() {
      const id = document.getElementById("bookId").value.trim();
      if (!id) return setStatus(ingestStatus, "Provide an id", true);
      setStatus(ingestStatus, "Checking status...");
      try {
        const res = await fetch(`/api/status?id=${encodeURIComponent(id)}&node=${encodeURIComponent(currentNode())}`);
        const data = await res.json();
        setStatus(ingestStatus, `Status: ${data.body?.status || "unknown"}`);
        ingestOutput.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        setStatus(ingestStatus, "Status check failed", true);
      }
    }

    async function search() {
      const query = document.getElementById("query").value.trim();
      const limit = document.getElementById("limit").value.trim() || "5";
      if (!query) return setStatus(searchStatus, "Provide a query", true);
      setStatus(searchStatus, "Searching...");
      searchOutput.textContent = "";
      try {
        const res = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=${encodeURIComponent(limit)}&node=${encodeURIComponent(currentNode())}`);
        const data = await res.json();
        setStatus(searchStatus, "Done.");
        searchOutput.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        setStatus(searchStatus, "Search failed", true);
      }
    }

    function setStatus(el, text, isError = false) {
      el.textContent = text;
      el.classList.toggle("error", isError);
      el.classList.toggle("ok", !isError);
    }

    function renderStats(stats) {
      const items = [
        ["Alive Nodes", stats.alive_nodes],
        ["CPU Usage", `${stats.cpu_usage.toFixed(1)}%`],
        ["Memory Used", `${stats.mem_used_mb} MB`],
        ["Memory Total", `${stats.mem_total_mb} MB`],
        ["Books (entries)", stats.books_entries],
        ["Books (partitions)", stats.books_partitions],
        ["Datalake (entries)", stats.datalake_entries],
        ["Datalake (partitions)", stats.datalake_partitions],
        ["Index (entries)", stats.index_entries],
        ["Index (partitions)", stats.index_partitions],
        ["Queue (tasks)", stats.queue_tasks],
        ["Queue pending", stats.queue_pending],
        ["Queue running", stats.queue_running],
        ["Queue completed", stats.queue_completed],
        ["Queue failed", stats.queue_failed],
      ];

      statsGrid.innerHTML = items
        .map(
          ([label, value]) =>
            `<div class="stat"><h3>${label}</h3><p>${value}</p></div>`
        )
        .join("");
    }

    async function pollStats() {
      try {
        const res = await fetch(`/api/stats?node=${encodeURIComponent(currentNode())}`);
        const data = await res.json();
        if (data.body) {
          renderStats(data.body);
          statsStatus.textContent = `Last update: ${new Date().toLocaleTimeString()}`;
        }
      } catch (err) {
        statsStatus.textContent = "Failed to fetch stats.";
      }
    }

    pollStats();
    setInterval(pollStats, 4000);
  </script>
</body>
</html>
